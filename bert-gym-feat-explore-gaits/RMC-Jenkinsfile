// Import lib to have access to conan and artifactory
@Library('rmc-jenkins-libraries-v2') _

node('default') {

  def context = conan.init()

  // checkout step. clone is located in "./repo_dir"
  stage('checkout'){
    dir("repo_dir") {
      checkout scm
    }
  }

  stage('config') {
    // Check versions and installed packages
    context.run(command: "--version")
    sh "source /opt/python/activate && python3 --version"
    sh label: "List pre-installed packages", script: "source /opt/python/activate && pip3 list"
  }

  stage('test') {
    dir("repo_dir") {
      // The shell env is not persistent
      sh script: """
      source /opt/rmc-build-tools/sourceme-devel.sh --cc "${WORKSPACE}/conan_home"
      # Install black/isort/flake8/...
      conan install conanfile.txt -u --build missing
      source ./activate_run_python.sh
      # Check codestyle with black and isort
      make check-codestyle
      # lint check
      make lint
      # Type check
      # make type
      # Run tests
      # make pytest
      # Build the doc
      # make doc
      """, label: 'Test commands'
    }
  }
}
